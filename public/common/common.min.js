if(typeof exports!="undefined"){var util=require("./util")}(function(exports){exports.Player=function(x,y){this.ACTIVE_SPEED=2;this.RELEASE_FOOD_WHEN_ACTIVE=500;this.LERP_CONSTANT=1.2;this._createId=function(length){var text="";var possible="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(var i=0;i<length;i++)text+=possible.charAt(Math.floor(Math.random()*possible.length));return text};this.id=this._createId(10);this.name="";this.x=x;this.y=y;this.angle;this.mx=0;this.my=0;this.originalWidth=50;this.originalHeight=50;this.width=this.originalWidth;this.height=this.originalHeight;this.originalSpeed=10;this.isInvisible=false;this.speed=10;this.socket=undefined;this.type="fish";this.sprite=undefined;this.isActiveDown=false;this.activeCounter=0;this.isDead=false;this.CYCLES_DEAD=50;this.deadCounter=0;this.image=undefined;this.collisionsCounter=0;this.timeBegin=Math.floor(Date.now()/1e3);this.foodEaten=0;this.render=function(ctx){if(this.isInvisible)ctx.globalAlpha=.4;ctx.save();ctx.translate(this.x,this.y);ctx.rotate(this.angle);if(this.isDead&&typeof this.image!="undefined"){ctx.globalAlpha=.2;ctx.drawImage(this.image,-this.width/2,-this.height/2,this.width,this.height);ctx.globalAlpha=1}else if(typeof this.sprite!="undefined")this.sprite.render(ctx,-this.width/2,-this.height/2,this.width,this.height);ctx.restore();if(this.isInvisible)ctx.globalAlpha=1;ctx.fillStyle="#FFFFFF";ctx.font="30px Verdana";ctx.fillText(this.name,this.x-this.width/2,this.y+this.height/2+50)};this.update=function(WIDTH,HEIGHT,world){if(this.isDead){this.deadCounter++;if(this.deadCounter>=this.CYCLES_DEAD){if(typeof this.endGame!="undefined"&&typeof this.endGame=="function")try{this.callEndGame();if(world.players.indexOf(this)!=-1)world.players.splice(world.players.indexOf(this),1)}catch(e){}}}else{this.angle=Math.atan2(this.my,this.mx);this.x+=Math.cos(this.angle)*this.speed;this.y+=Math.sin(this.angle)*this.speed;if(this.x-this.width/2<=0){this.x=this.width/2}if(this.y-this.height/2<=0){this.y=this.height/2}if(this.x+this.width/2>=WIDTH){this.x=WIDTH-this.width/2}if(this.y+this.height/2>=HEIGHT){this.y=HEIGHT-this.height/2}}};this.callEndGame=function(){this.endGame(Math.floor(Date.now()/1e3)-this.timeBegin,this.collisionsCounter-1,this.width-this.originalWidth,this.foodEaten)};this.grow=function(grow_ratio){this.width+=grow_ratio*(this.originalWidth/(this.originalWidth+this.originalHeight));this.height+=grow_ratio*(this.originalHeight/(this.originalWidth+this.originalHeight))};this.minimize=function(grow_ratio){if(this.width-this.originalWidth>0){this.width-=grow_ratio*(this.originalWidth/(this.originalWidth+this.originalHeight));this.height-=grow_ratio*(this.originalHeight/(this.originalWidth+this.originalHeight))}if(this.width-this.originalWidth<0){this.width=this.originalWidth;this.height=this.originalHeight}if(this.height-this.originalHeight<0){this.height=this.originalHeight;this.width=this.originalHeight}};this.toJSON=function(){return{id:this.id,name:this.name,x:this.x,y:this.y,angle:this.angle,originalWidth:this.originalWidth,originalHeight:this.originalHeight,width:this.width,height:this.height,isInvisible:this.isInvisible,isDead:this.isDead,type:this.type}};this.fromJSON=function(json){if(typeof json=="undefined")return this;this.id=json.id;this.name=json.name;this.x=json.x;this.y=json.y;this.angle=json.angle;this.originalWidth=json.originalWidth;this.originalHeight=json.originalHeight;this.width=json.width;this.height=json.height;this.isDead=json.isDead;this.isInvisible=json.isInvisible;this.type=json.type;return this}}})(typeof exports==="undefined"?window:exports);if(typeof exports!="undefined"){var shark=require("./shark");var fish=require("./fish");var spiky=require("./spiky");var player=require("./player");var food=require("./food");var corals=require("./coral");var util=require("./util");var bot=require("./bot");var runes=require("./runes")}(function(exports){exports.create=function(WIDTH,HEIGHT,sockets){var world=new exports.World(WIDTH,HEIGHT,sockets);return world};exports.World=function(WIDTH,HEIGHT,type){this.TOTAL_PLAYERS_WITH_BOTS_NUMBER=40;this.MAXIMAL_BOTS_WIDTH=400;this.COLLISION_EPSILON_WIDTH=.4;this.COLLISION_EPSILON_HEIGHT=.6;this.COLLISION_FOOD_EPSILON_WIDTH=.6;this.COLLISION_FOOD_EPSILON_HEIGHT=.8;this.DECREASE_SPEED=.01;this.MINIMAL_SPEED=2;this.IGNORE_COLLISION_RATIO=.1;this.SPIKY_INCREASE_SIZE_RATIO=1.2;this.SHARK_INCREASE_SIZE_RATIO=.8;this.MINIMUM_CORALS=10;this.MAXIMUM_CORALS=20;this.MINIMUM_RUNES=100;this.MAXIMUM_RUNES=200;this.FOOD_INCREASE_SIZE_RATIO=2.5;this.MINIMUM_FOOD=1300;this.FOOD_PACK_MINIMUM=75;this.FOOD_PACK_MAXIMUM=100;this.FOOD_FOR_DEAD_PLAYER_TIMES_WIDTH=.1;this.FOOD_OFFSET=500;this.LOOSE_WEIGHT_AFTER=1e3;this.LOOSE_WEIGHT=2;this.LOOSE_WEIGHT_WHEN_ACTIVE=2;this.looseWeightCounter=0;this.SHOW_BROWSER_RADIUS=1e3;this.SHOW_MOBILE_RADIUS=860;this.WIDTH=WIDTH;this.HEIGHT=HEIGHT;this.type=type;this.players=[];this.bots=[];this.food=[];this.corals=[];if(this.type=="bonus")this.runes=[];this.update=function(){var self=this;for(var i=0;i<this.players.length;i++)this.players[i].update(this.WIDTH,this.HEIGHT,this);for(var i=0;i<this.bots.length;i++){this.bots[i].update(this.players,this.bots,this.corals,this.food,this.WIDTH,this.HEIGHT);if(this.bots[i].width>this.MAXIMAL_BOTS_WIDTH)this.bots.splice(i,1)}for(var i=0;i<this.food.length;i++)this.food[i].update();if(this.food.length<this.MINIMUM_FOOD)this.generateFood(this.FOOD_OFFSET,this.FOOD_OFFSET,this.WIDTH-this.FOOD_OFFSET,this.HEIGHT-this.FOOD_OFFSET,this.FOOD_PACK_MINIMUM+Math.random()*(this.FOOD_PACK_MAXIMUM-this.FOOD_PACK_MINIMUM),true);if(this.corals.length<this.MINIMUM_CORALS)this.generateCorals(0,0,this.WIDTH,this.HEIGHT,this.MINIMUM_CORALS+Math.random()*(this.MAXIMUM_CORALS-this.MINIMUM_CORALS));for(var i=0;i<this.players.length;i++)for(var j=0;j<this.food.length;j++){if(this.players[i].isDead)continue;if(this.checkCollision(this.players[i],this.food[j],this.COLLISION_FOOD_EPSILON_WIDTH,this.COLLISION_FOOD_EPSILON_HEIGHT)){if(this.players[i].speed-this.DECREASE_SPEED>this.MINIMAL_SPEED){this.players[i].speed-=this.food[j].isSuper?this.DECREASE_SPEED*3:this.DECREASE_SPEED;this.players[i].originalSpeed-=this.food[j].isSuper?this.DECREASE_SPEED*2:this.DECREASE_SPEED}this.players[i].foodEaten++;var increase=this.food[j].isSuper?this.FOOD_INCREASE_SIZE_RATIO*3:this.FOOD_INCREASE_SIZE_RATIO;increase*=this.players[i].type=="spiky"?this.SPIKY_INCREASE_SIZE_RATIO:this.players[i].type=="shark"?this.SHARK_INCREASE_SIZE_RATIO:1;this.players[i].grow(increase);this.food.splice(j,1)}}for(var i=0;i<this.bots.length;i++)for(var j=0;j<this.food.length;j++)if(this.checkCollision(this.bots[i],this.food[j],this.COLLISION_FOOD_EPSILON_WIDTH,this.COLLISION_FOOD_EPSILON_HEIGHT)){var increase=this.food[j].isSuper?this.FOOD_INCREASE_SIZE_RATIO*3:this.FOOD_INCREASE_SIZE_RATIO;increase*=this.bots[i].type=="spiky"?this.SPIKY_INCREASE_SIZE_RATIO:this.bots[i].type=="shark"?this.SHARK_INCREASE_SIZE_RATIO:1;this.bots[i].grow(increase);this.food.splice(j,1)}for(var i=0;i<this.players.length;i++)for(var j=0;j<this.corals.length;j++){if(this.players[i].isDead)continue;if(this.players[i].width<this.corals[j].width&&this.players[i].height<this.corals[j].height)continue;if(this.checkCollision(this.players[i],this.corals[j],this.COLLISION_EPSILON_WIDTH,this.COLLISION_EPSILON_HEIGHT)){this.players[i].speed+=this.DECREASE_SPEED*5;this.players[i].originalSpeed+=this.DECREASE_SPEED*5;this.players[i].minimize(this.FOOD_INCREASE_SIZE_RATIO*5);this.generateFood(this.corals[j].x-this.corals[j].width/2,this.corals[j].y-this.corals[j].height/2,this.corals[j].x+this.corals[j].width/2,this.corals[j].y+this.corals[j].height/2,1)}}for(var i=0;i<this.bots.length;i++)for(var j=0;j<this.corals.length;j++){if(this.bots[i].width<this.corals[j].width&&this.bots[i].height<this.corals[j].height)continue;if(this.checkCollision(this.bots[i],this.corals[j],this.COLLISION_EPSILON_WIDTH,this.COLLISION_EPSILON_HEIGHT)){this.bots[i].speed+=this.DECREASE_SPEED*5;this.bots[i].minimize(this.FOOD_INCREASE_SIZE_RATIO*5);this.generateFood(this.corals[j].x-this.corals[j].width/2,this.corals[j].y-this.corals[j].height/2,this.corals[j].x+this.corals[j].width/2,this.corals[j].y+this.corals[j].height/2,1)}}for(var i=0;i<this.players.length;i++)for(var j=0;j<this.players.length;j++){if(this.players[i].isDead)continue;if(this.players[j].isDead)continue;if(Math.abs(this.players[i].width-this.players[j].width)<util.max(this.players[i].width-this.players[i].originalWidth,this.players[j].width-this.players[j].originalWidth)*this.IGNORE_COLLISION_RATIO)continue;if(i==j)continue;if(this.checkCollision(this.players[i],this.players[j],this.COLLISION_EPSILON_WIDTH,this.COLLISION_EPSILON_HEIGHT)){this.players[i].collisionsCounter++;this.players[j].collisionsCounter++;if(this.players[i].width>this.players[j].width){this.generateFood(this.players[j].x-this.players[j].width/2,this.players[j].y-this.players[j].height/2,this.players[j].x+this.players[j].width/2,this.players[j].y+this.players[j].height/2,this.players[j].width*this.FOOD_FOR_DEAD_PLAYER_TIMES_WIDTH);this.players[j].isDead=true;return this}else if(this.players[i].width<this.players[j].width){this.generateFood(this.players[i].x-this.players[i].width/2,this.players[i].y-this.players[i].height/2,this.players[i].x+this.players[i].width/2,this.players[i].y+this.players[i].height/2,this.players[i].width*this.FOOD_FOR_DEAD_PLAYER_TIMES_WIDTH);this.players[i].isDead=true;return this}}}for(var i=0;i<this.players.length;i++)for(var j=0;j<this.bots.length;j++){if(this.players[i].isDead)continue;if(Math.abs(this.players[i].width-this.bots[j].width)<util.max(this.players[i].width-this.players[i].originalWidth,this.bots[j].width-this.bots[j].originalWidth)*this.IGNORE_COLLISION_RATIO)continue;if(this.checkCollision(this.players[i],this.bots[j],this.COLLISION_EPSILON_WIDTH,this.COLLISION_EPSILON_HEIGHT)){this.players[i].collisionsCounter++;if(this.players[i].width>this.bots[j].width){this.generateFood(this.bots[j].x-this.bots[j].width/2,this.bots[j].y-this.bots[j].height/2,this.bots[j].x+this.bots[j].width/2,this.bots[j].y+this.bots[j].height/2,this.bots[j].width*this.FOOD_FOR_DEAD_PLAYER_TIMES_WIDTH);if(typeof this.bots[j].endGame!="undefined"&&typeof this.bots[j].endGame=="function")this.bots[j].endGame();this.bots.splice(j,1);return this}else if(this.players[i].width<this.bots[j].width){this.generateFood(this.players[i].x-this.players[i].width/2,this.players[i].y-this.players[i].height/2,this.players[i].x+this.players[i].width/2,this.players[i].y+this.players[i].height/2,this.players[i].width*this.FOOD_FOR_DEAD_PLAYER_TIMES_WIDTH);this.players[i].isDead=true;return this}}}for(var i=0;i<this.bots.length;i++)for(var j=0;j<this.bots.length;j++){if(i==j)continue;if(Math.abs(this.bots[i].width-this.bots[j].width)<util.max(this.bots[i].width-this.bots[i].originalWidth,this.bots[j].width-this.bots[j].originalWidth)*this.IGNORE_COLLISION_RATIO)continue;if(this.checkCollision(this.bots[i],this.bots[j],this.COLLISION_EPSILON_WIDTH,this.COLLISION_EPSILON_HEIGHT)){if(this.bots[i].width>this.bots[j].width){this.generateFood(this.bots[j].x-this.bots[j].width/2,this.bots[j].y-this.bots[j].height/2,this.bots[j].x+this.bots[j].width/2,this.bots[j].y+this.bots[j].height/2,this.bots[j].width*this.FOOD_FOR_DEAD_PLAYER_TIMES_WIDTH);if(typeof this.bots[j].endGame!="undefined"&&typeof this.bots[j].endGame=="function")this.bots[j].endGame();this.bots.splice(j,1);return this}else if(this.bots[i].width<this.bots[j].width){this.generateFood(this.bots[i].x-this.bots[i].width/2,this.bots[i].y-this.bots[i].height/2,this.bots[i].x+this.bots[i].width/2,this.bots[i].y+this.bots[i].height/2,this.bots[i].width*this.FOOD_FOR_DEAD_PLAYER_TIMES_WIDTH);if(typeof this.bots[i].endGame!="undefined"&&typeof this.bots[i].endGame=="function")this.bots[i].endGame();this.bots.splice(i,1);return this}}}this.looseWeightCounter++;if(this.looseWeightCounter==this.LOOSE_WEIGHT_AFTER){for(var i=0;i<this.players.length;i++){this.players[i].minimize(this.LOOSE_WEIGHT);this.players[i].speed+=this.DECREASE_SPEED;this.players[i].originalSpeed+=this.DECREASE_SPEED}for(var i=0;i<this.bots.length;i++){this.bots[i].minimize(this.LOOSE_WEIGHT)}this.looseWeightCounter=0}for(var i=0;i<this.players.length;i++){if(this.players[i].isActiveDown&&this.players[i].width-this.players[i].originalWidth>0){this.players[i].activeCounter++;this.players[i].speed=this.players[i].ACTIVE_SPEED*this.players[i].originalSpeed;if(this.players[i].activeCounter>=this.players[i].RELEASE_FOOD_WHEN_ACTIVE/this.players[i].width){this.players[i].activeCounter=0;this.players[i].minimize(this.LOOSE_WEIGHT_WHEN_ACTIVE);if(typeof this.players[i].angle!="undefined"){var tailX=this.players[i].x+Math.cos(this.players[i].angle+Math.PI)*this.players[i].width;var tailY=this.players[i].y+Math.sin(this.players[i].angle+Math.PI)*this.players[i].height;this.food.push(new food.Food(tailX,tailY))}}}else{this.players[i].speed=this.players[i].originalSpeed}}var players_with_bots=this.players.length+this.bots.length;if(players_with_bots<this.TOTAL_PLAYERS_WITH_BOTS_NUMBER){this.bots.push(new bot.AI_Bot(Math.random()*this.WIDTH,Math.random()*this.HEIGHT))}if(players_with_bots>this.TOTAL_PLAYERS_WITH_BOTS_NUMBER&&this.bots.length>0)this.bots.splice(0,players_with_bots-this.TOTAL_PLAYERS_WITH_BOTS_NUMBER>this.bots.length?this.bots.length:players_with_bots-this.TOTAL_PLAYERS_WITH_BOTS_NUMBER);if(typeof this.runes!="undefined"){if(this.runes.length<this.MINIMUM_RUNES){for(var i=0;i<this.MINIMUM_RUNES-this.runes.length;i++){for(var j=0;j<Math.random()*(this.MAXIMUM_RUNES-this.MINIMUM_RUNES);j++){var rnd=Math.random();if(rnd<1/6){this.runes.push(new runes.HasteRune(Math.random()*this.WIDTH,Math.random()*this.HEIGHT))}else if(rnd<2/6){this.runes.push(new runes.VolumeRune(Math.random()*this.WIDTH,Math.random()*this.HEIGHT))}else if(rnd<3/6){this.runes.push(new runes.DecreaseRune(Math.random()*this.WIDTH,Math.random()*this.HEIGHT))}else if(rnd<4/6){this.runes.push(new runes.InvisRune(Math.random()*this.WIDTH,Math.random()*this.HEIGHT))}else if(rnd<5/6){this.runes.push(new runes.SlowRune(Math.random()*this.WIDTH,Math.random()*this.HEIGHT))}else{this.runes.push(new runes.UnknownRune(Math.random()*this.WIDTH,Math.random()*this.HEIGHT))}}}}for(var i=0;i<this.runes.length;i++){this.runes[i].update();if(typeof this.runes[i]=="undefined")continue;if(!this.runes[i].isActivated){for(var j=0;j<this.players.length;j++){if(typeof this.runes[i]=="undefined")continue;if(this.checkCollision(this.players[j],this.runes[i],this.COLLISION_EPSILON_WIDTH,this.COLLISION_EPSILON_HEIGHT)){for(var k=0;k<this.runes.length;k++){if(this.runes[k].player==this.players[j])this.runes[k].deactivate()}if(typeof this.runes[i]!="undefined"){var rune=this.runes[i];rune.activate(this.players[j],this);rune.isActivated=true}}}for(var j=0;j<this.bots.length;j++){if(typeof this.runes[i]=="undefined")continue;if(this.checkCollision(this.bots[j],this.runes[i],this.COLLISION_EPSILON_WIDTH,this.COLLISION_EPSILON_HEIGHT)){for(var k=0;k<this.runes.length;k++){if(this.runes[k].player==this.bots[j])this.runes[k].deactivate()}if(typeof this.runes[i]!="undefined"){var rune=this.runes[i];rune.activate(this.bots[j],this);rune.isActivated=true}}}}}}return this};this.render=function(ctx){for(var i=0;i<this.food.length;i++)this.food[i].render(ctx);if(typeof this.runes!="undefined"){for(var i=0;i<this.runes.length;i++)this.runes[i].render(ctx)}for(var i=0;i<this.bots.length;i++)this.bots[i].render(ctx);for(var i=0;i<this.players.length;i++)this.players[i].render(ctx);for(var i=0;i<this.corals.length;i++)this.corals[i].render(ctx);return this};this.addPlayer=function(data){if(typeof data=="undefined")return;var player;switch(data.type){case"shark":player=new shark.Shark(Math.random()*this.WIDTH,Math.random()*this.HEIGHT);break;case"fish":player=new fish.Fish(Math.random()*this.WIDTH,Math.random()*this.HEIGHT);break;case"spiky":player=new spiky.Spiky(Math.random()*this.WIDTH,Math.random()*this.HEIGHT);break}if(typeof player!="undefined"){player.type=data.type;player.name=data.name.length<=15?data.name:"";this.players.push(player);return player}};this.removePlayer=function(player){if(this.players.indexOf(player)>-1)this.players.splice(this.players.indexOf(player),1);return this};this.getPlayerById=function(id){for(var i=0;i<this.players.length;i++){if(this.players[i].id==id)return this.players[i]}};this.generateFood=function(x1,y1,x2,y2,how_many,canBeSuper){if(typeof canBeSuper=="undefined")canBeSuper=false;for(var i=0;i<=Math.floor(how_many);i++){if(typeof window=="undefined")this.food.push(new food.Food(x1+Math.random()*(x2-x1),y1+Math.random()*(y2-y1),canBeSuper));else this.food.push(new Food(x1+Math.random()*(x2-x1),y1+Math.random()*(y2-y1),canBeSuper))}};this.generateCorals=function(x1,y1,x2,y2,how_many){for(var i=0;i<=Math.floor(how_many);i++){if(typeof window=="undefined")this.corals.push(new corals.Coral(x1+Math.random()*(x2-x1),y1+Math.random()*(y2-y1)));else this.corals.push(new Coral(x1+Math.random()*(x2-x1),y1+Math.random()*(y2-y1)))}};this.toJSON=function(){var players=[];for(var i=0;i<this.players.length;i++){players.push(this.players[i].toJSON())}var bots=[];for(var i=0;i<this.bots.length;i++){bots.push(this.bots[i].toJSON())}var food=[];for(var i=0;i<this.food.length;i++){food.push(this.food[i].toJSON())}if(typeof this.runes!="undefined"){var runes=[];for(var i=0;i<this.runes.length;i++){runes.push(this.runes[i].toJSON())}}var corals=[];for(var i=0;i<this.corals.length;i++){corals.push(this.corals[i].toJSON())}return{players:players,bots:bots,food:food,runes:runes,corals:corals,WIDTH:this.WIDTH,HEIGHT:this.HEIGHT}};this.toJSONWithDistance=function(player,device){var showRadius=device=="browser"?this.SHOW_BROWSER_RADIUS:this.SHOW_MOBILE_RADIUS;var scale=Math.pow(player.originalWidth/player.width,.2);var players=[];for(var i=0;i<this.players.length;i++){if(this.players[i]==player||this.players[i].isInvisible==false)players.push(this.players[i].toJSON())}this.bots.sort(function(a,b){return b.width-b.originalWidth-(a.width-a.originalWidth)});var bots=[];for(var i=0;i<this.bots.length;i++){if(i<=10){if(this.bots[i].isInvisible==false)bots.push(this.bots[i].toJSON())}else{if(this.bots[i].isInvisible==false&&util.getDistance(player,this.bots[i])<showRadius/scale)bots.push(this.bots[i].toJSON())}}var food=[];for(var i=0;i<this.food.length;i++){if(util.getDistance(player,this.food[i])<showRadius/scale)food.push(this.food[i].toJSON())}if(typeof this.runes!="undefined"){var runes=[];for(var i=0;i<this.runes.length;i++){if(util.getDistance(player,this.runes[i])<showRadius/scale)runes.push(this.runes[i].toJSON())}}var corals=[];for(var i=0;i<this.corals.length;i++){if(util.getDistance(player,this.corals[i])<showRadius/scale)corals.push(this.corals[i].toJSON())}return{players:players,bots:bots,food:food,runes:runes,corals:corals,WIDTH:this.WIDTH,HEIGHT:this.HEIGHT}};this.fromJSON=function(json){this.players=[];this.bots=[];this.food=[];this.corals=[];this.WIDTH=json.WIDTH;this.HEIGHT=json.HEIGHT;for(var i=0;i<json.players.length;i++){this.players.push((new Player).fromJSON(json.players[i]))}for(var i=0;i<json.bots.length;i++){this.bots.push(new AI_Bot(0,0).fromJSON(json.bots[i]))}for(var i=0;i<json.food.length;i++){this.food.push(new Food(0,0).fromJSON(json.food[i]))}if(typeof json.runes!="undefined"){this.runes=[];for(var i=0;i<json.runes.length;i++){switch(json.runes[i].type){case"haste":this.runes.push(new HasteRune(0,0).fromJSON(json.runes[i]));break;case"volume":this.runes.push(new VolumeRune(0,0).fromJSON(json.runes[i]));break;case"decrease":this.runes.push(new DecreaseRune(0,0).fromJSON(json.runes[i]));break;case"invis":this.runes.push(new InvisRune(0,0).fromJSON(json.runes[i]));break;case"slow":this.runes.push(new SlowRune(0,0).fromJSON(json.runes[i]));break;case"unknown":this.runes.push(new UnknownRune(0,0).fromJSON(json.runes[i]));break}}}for(var i=0;i<json.corals.length;i++){this.corals.push(new Coral(0,0).fromJSON(json.corals[i]))}return this};this.checkCollision=function(entity1,entity2,epsilonWidth,epsilonHeight){var dist=util.getDistance(entity1,entity2);if(dist>entity1.width+entity2.width&&dist>entity1.height+entity2.height)return false;var width1=entity1.width;var height1=entity1.height;var width2=entity2.width;var height2=entity2.height;width1*=epsilonWidth;height1*=epsilonHeight;width2*=epsilonWidth;height2*=epsilonWidth;width1/=2;height1/=2;width2/=2;height2/=2;if(typeof entity1.angle=="undefined")entity1.angle=0;if(typeof entity2.angle=="undefined")entity2.angle=0;var radius1=Math.sqrt(height1*height1+width1*width1);var radius2=Math.sqrt(height2*height2+width2*width2);var angle1=Math.asin(height1/radius1);var angle2=Math.asin(height2/radius2);var x1=[];var x2=[];var y1=[];var y2=[];x1[0]=entity1.x+radius1*Math.cos(entity1.angle-angle1);y1[0]=entity1.y+radius1*Math.sin(entity1.angle-angle1);x1[1]=entity1.x+radius1*Math.cos(entity1.angle+angle1);y1[1]=entity1.y+radius1*Math.sin(entity1.angle+angle1);x1[2]=entity1.x+radius1*Math.cos(entity1.angle+Math.PI-angle1);y1[2]=entity1.y+radius1*Math.sin(entity1.angle+Math.PI-angle1);x1[3]=entity1.x+radius1*Math.cos(entity1.angle+Math.PI+angle1);y1[3]=entity1.y+radius1*Math.sin(entity1.angle+Math.PI+angle1);x2[0]=entity2.x+radius2*Math.cos(entity2.angle-angle2);y2[0]=entity2.y+radius2*Math.sin(entity2.angle-angle2);x2[1]=entity2.x+radius2*Math.cos(entity2.angle+angle2);y2[1]=entity2.y+radius2*Math.sin(entity2.angle+angle2);x2[2]=entity2.x+radius2*Math.cos(entity2.angle+Math.PI-angle2);y2[2]=entity2.y+radius2*Math.sin(entity2.angle+Math.PI-angle2);x2[3]=entity2.x+radius2*Math.cos(entity2.angle+Math.PI+angle2);y2[3]=entity2.y+radius2*Math.sin(entity2.angle+Math.PI+angle2);var axisx=[];var axisy=[];axisx[0]=x1[0]-x1[1];axisy[0]=y1[0]-y1[1];axisx[1]=x1[2]-x1[1];axisy[1]=y1[2]-y1[1];axisx[2]=x2[0]-x2[1];axisy[2]=y2[0]-y2[1];axisx[3]=x2[2]-x2[1];axisy[3]=y2[2]-y2[1];for(var k=0;k<4;k++){var proj=x1[0]*axisx[k]+y1[0]*axisy[k];var minProj1=proj;var maxProj1=proj;for(var i=1;i<4;i++){proj=x1[i]*axisx[k]+y1[i]*axisy[k];if(proj<minProj1)minProj1=proj;else if(proj>maxProj1)maxProj1=proj}proj=x2[0]*axisx[k]+y2[0]*axisy[k];var minProj2=proj;var maxProj2=proj;for(var j=1;j<4;j++){proj=x2[j]*axisx[k]+y2[j]*axisy[k];if(proj<minProj2)minProj2=proj;else if(proj>maxProj2)maxProj2=proj}if(maxProj2<minProj1||maxProj1<minProj2)return false}return true}}})(typeof exports==="undefined"?window:exports);if(typeof window=="undefined"){var util=require("./util");var names=require("./names")}(function(exports){exports.AI_Bot=function(x,y){this.LERP_CONSTANT=.5;this.x=x;this.y=y;this.name="";this.dir={x:0,y:0};this.originalWidth=100;this.originalHeight=50;this.width=this.originalWidth;this.height=this.originalHeight;this.sprite=undefined;var rnd=Math.random();this.type=rnd<1/3?"shark":rnd<2/3?"fish":"spiky";this.angle=0;this.maximalSpeed=this.type=="shark"?11:this.type=="spiky"?9:10;this.originalSpeed=this.maximalSpeed;this.speed=this.originalSpeed;this.weightedDirections=[];this.isInvisible=false;this.activeCounter=0;this.WANDER_CHANGE_DIRECTION_AFTER=100;this.wanderCounter=0;this.lastWanderX=Math.random()*10-5;this.lastWanderY=Math.random()*10-5;this.WANDER_WEIGHT=Math.random()*5;this.FIND_FOOD_WEIGHT=10;this.FLEE_RADIUS=500;this.FLEE_WEIGHT=6e3;this.CHARGE_RADIUS=500;this.CHARGE_WEIGHT=6e3;this.HIDE_RADIUS=300+Math.random()*400;this.HIDE_WEIGHT=Math.random()*80;this.ACTIVE_DIST=300;this.update=function(players,bots,corals,food,WIDTH,HEIGHT){if(typeof this.name=="undefined"||this.name=="")this.generateName();this.speed=this.originalWidth/this.width*this.maximalSpeed;this.dir.x=0;this.dir.y=0;this.weightedDirections=[];var closest=undefined;var dist=Number.POSITIVE_INFINITY;for(var i=0;i<players.length;i++){var d=util.getDistance(this,players[i]);if(d<dist&&players[i].isInvisible==false){closest=players[i];dist=d}}for(var i=0;i<bots.length;i++){if(bots[i]==this)continue;var d=util.getDistance(this,bots[i]);if(d<dist&&bots[i].isInvisible==false){closest=bots[i];dist=d}}this.AI_Wander();this.AI_FindFood(food);this.AI_FleeFromLargerFish(closest,dist);this.AI_ChargeSmallerFish(closest,dist);this.AI_HideInTheCoral(closest,dist,corals);for(var i=0;i<this.weightedDirections.length;i++){this.dir.x+=this.weightedDirections[i].x*this.weightedDirections[i].weight;this.dir.y+=this.weightedDirections[i].y*this.weightedDirections[i].weight}this.dir=util.lerp(util.getVectorFromAngle(this.angle,util.getVectorLength(this.dir)),this.dir,this.LERP_CONSTANT);this.angle=Math.atan2(this.dir.y,this.dir.x);this.x+=Math.cos(this.angle)*this.speed;this.y+=Math.sin(this.angle)*this.speed;if(this.x-this.width/2<=0){this.x=this.width/2}if(this.y-this.height/2<=0){this.y=this.height/2}if(this.x+this.width/2>=WIDTH){this.x=WIDTH-this.width/2}if(this.y+this.height/2>=HEIGHT){this.y=HEIGHT-this.height/2}};this.generateName=function(){this.name=names.list[Math.floor(Math.random()*(names.list.length+1))]};this.render=function(ctx){ctx.save();ctx.translate(this.x,this.y);ctx.rotate(this.angle);if(typeof this.sprite!="undefined")this.sprite.render(ctx,-this.width/2,-this.height/2,this.width,this.height);ctx.restore();ctx.fillStyle="#FFFFFF";ctx.font="30px Verdana";ctx.fillText(this.name,this.x-this.width/2,this.y+this.height/2+50)};this.grow=function(grow_ratio){this.width+=grow_ratio*(this.originalWidth/(this.originalWidth+this.originalHeight));this.height+=grow_ratio*(this.originalHeight/(this.originalWidth+this.originalHeight))};this.minimize=function(grow_ratio){if(this.width-this.originalWidth>0){this.width-=grow_ratio*(this.originalWidth/(this.originalWidth+this.originalHeight));this.height-=grow_ratio*(this.originalHeight/(this.originalWidth+this.originalHeight))}if(this.width-this.originalWidth<0){this.width=this.originalWidth;this.height=this.originalHeight}if(this.height-this.originalHeight<0){this.height=this.originalHeight;this.width=this.originalHeight}};this.fromJSON=function(json){this.x=json.x;this.y=json.y;this.width=json.width;this.height=json.height;this.originalWidth=json.originalWidth;this.originalHeight=json.originalHeight;this.type=json.type;this.angle=json.angle;this.speed=json.speed;this.name=json.name;return this};this.toJSON=function(){return{x:this.x,y:this.y,angle:this.angle,originalWidth:this.originalWidth,originalHeight:this.originalHeight,width:this.width,height:this.height,speed:this.speed,type:this.type,name:this.name}};this.AI_Wander=function(){if(this.wanderCounter==this.WANDER_CHANGE_DIRECTION_AFTER){this.lastWanderX=Math.random()*10-5;this.lastWanderY=Math.random()*10-5;this.wanderCounter=0}this.weightedDirections.push({x:this.lastWanderX,y:this.lastWanderY,weight:this.WANDER_WEIGHT});this.wanderCounter++};this.AI_FindFood=function(food){var closest=undefined;var dist=Number.POSITIVE_INFINITY;for(var i=0;i<food.length;i++){var d=util.getDistance(this,food[i]);if(d<dist){closest=food[i];dist=d}}if(typeof closest=="undefined")return;this.weightedDirections.push({x:closest.x-this.x,y:closest.y-this.y,weight:this.FIND_FOOD_WEIGHT})};this.AI_FleeFromLargerFish=function(closest,dist){if(typeof closest=="undefined")return;if(closest.width<this.width)return;if(dist-closest.width>this.FLEE_RADIUS)return;this.weightedDirections.push({x:-(closest.x-this.x),y:-(closest.y-this.y),weight:this.FLEE_WEIGHT/dist})};this.AI_ChargeSmallerFish=function(closest,dist){if(typeof closest=="undefined")return;if(closest.width>this.width)return;if(dist-closest.width>this.CHARGE_RADIUS)return;this.weightedDirections.push({x:closest.x-this.x,y:closest.y-this.y,weight:this.CHARGE_WEIGHT/dist})};this.AI_HideInTheCoral=function(closestFish,dist,corals){if(corals.length<=0)return;if(corals[0].width<this.width||corals[0].height<this.height)return;if(dist>this.HIDE_RADIUS)return;if(typeof closestFish=="undefined")return;if(closestFish.width<corals[0].width||closestFish.height<corals.height)return;var closestCoral=undefined;var dist=Number.POSITIVE_INFINITY;for(var i=0;i<corals.length;i++){var d=util.getDistance(this,corals[i]);if(d<dist){closestCoral=corals[i];dist=d}}if(typeof closestCoral=="undefined")return;this.weightedDirections.push({x:closestCoral.x-this.x,y:closestCoral.y-this.y,weight:this.HIDE_WEIGHT})}}})(typeof exports==="undefined"?window:exports);(function(exports){exports.Coral=function(x,y){this.width=200;this.height=200;this.image;this.x=x;this.y=y;this.angle=Math.random()*2*Math.PI;this.toJSON=function(){return{x:this.x,y:this.y,angle:this.angle}};this.fromJSON=function(json){this.x=json.x;this.y=json.y;this.angle=json.angle;return this};this.render=function(ctx){ctx.save();ctx.translate(this.x,this.y);ctx.rotate(this.angle);if(typeof this.image!=undefined)ctx.drawImage(this.image,-this.width/2,-this.height/2,this.width,this.height);ctx.restore();return this}}})(typeof exports==="undefined"?window:exports);(function(exports){exports.Food=function(x,y,canBeSuper){if(typeof canBeSuper=="undefined")canBeSuper=false;this.ACCELERATION=.2;this.MAX_VELOCITY=5;this.CHANCE_TO_BE_SUPER=.1;this.image;this.firstX=x;this.firstY=y;this.x=x;this.y=y;this.width=10;this.height=10;this.isSuper=canBeSuper&&Math.random()<this.CHANCE_TO_BE_SUPER?true:false;if(this.isSuper){this.width=20;this.height=20}this.velocity={x:0,y:0};this.acceleration={x:this.ACCELERATION,y:0};this.render=function(ctx){if(typeof this.image!=undefined){if(this.isSuper==false)ctx.drawImage(this.image,this.x-this.width/2,this.y-this.height/2,this.width,this.height);else ctx.drawImage(this.image,this.x-this.width,this.y-this.height,this.width*2,this.height*2)}return this};this.update=function(){this.velocity.x+=this.acceleration.x;this.velocity.y+=this.acceleration.y;this.x+=this.velocity.x;this.y+=this.velocity.y;if(this.velocity.x>this.MAX_VELOCITY)this.acceleration.x=-this.ACCELERATION;else if(this.velocity.x<-this.MAX_VELOCITY)this.acceleration.x=+this.ACCELERATION};this.toJSON=function(){var json={};json.x=this.x;json.y=this.y;json.isSuper=this.isSuper;return json};this.fromJSON=function(json){if(json!=null&&typeof json!="undefined"){this.x=json.x;this.y=json.y;this.isSuper=json.isSuper}return this}}})(typeof exports==="undefined"?window:exports);if(typeof exports!="undefined"){var runes=require("./runes")}(function(exports){var TIME_ACTIVE=200;exports.HasteRune=function(x,y){this.x=x;this.y=y;this.counter=0;this.player=undefined;this.width=50;this.height=50;this.isActivated=false;this.type="haste";this.image=undefined;this.world=undefined;this.color="#EB3636";this.render=function(ctx){if(this.isActivated==false&&typeof this.image!=undefined)ctx.drawImage(this.image,this.x-this.width/2,this.y-this.height/2);else if(this.isActivated==true){ctx.globalAlpha=.5;ctx.beginPath();ctx.arc(this.x,this.y,this.width,0,2*Math.PI,false);ctx.fillStyle=this.color;ctx.fill();ctx.closePath();ctx.globalAlpha=1}return this};this.update=function(){if(typeof this.player!="undefined"){this.counter++;this.x=this.player.x;this.y=this.player.y;this.width=this.player.width;this.player.speed=2*this.player.originalSpeed;if(this.counter>=TIME_ACTIVE){this.deactivate()}}};this.activate=function(player,world){this.world=world;this.player=player;this.player.speed=2*this.player.originalSpeed};this.deactivate=function(){this.player.speed=this.player.originalSpeed;if(typeof this.world!="undefined"&&this.world.runes.indexOf(this)!=-1)this.world.runes.splice(this.world.runes.indexOf(this),1)};this.toJSON=function(){return{x:this.x,y:this.y,type:this.type,isActivated:this.isActivated}};this.fromJSON=function(json){this.x=json.x;this.y=json.y;this.type=json.type;this.isActivated=json.isActivated;return this}};exports.VolumeRune=function(x,y){this.x=x;this.y=y;this.counter=0;this.player=undefined;this.type="volume";this.width=50;this.height=50;this.isActivated=false;this.grown=0;this.image=undefined;this.world=undefined;this.color="#EBC005";this.render=function(ctx){if(this.isActivated==false&&typeof this.image!=undefined)ctx.drawImage(this.image,this.x-this.width/2,this.y-this.height/2);else if(this.isActivated==true){
ctx.globalAlpha=.5;ctx.beginPath();ctx.arc(this.x,this.y,this.width,0,2*Math.PI,false);ctx.fillStyle=this.color;ctx.fill();ctx.closePath();ctx.globalAlpha=1}return this};this.update=function(){if(typeof this.player!="undefined"){this.counter++;this.x=this.player.x;this.y=this.player.y;this.width=this.player.width;if(this.counter>=TIME_ACTIVE){this.deactivate()}}};this.activate=function(player,world){this.world=world;this.player=player;this.grown=(this.player.width-this.player.originalWidth)*1.2;if(this.player.speed-this.world.DECREASE_SPEED*(this.grown/this.world.FOOD_INCREASE_SIZE_RATIO)>this.world.MINIMAL_SPEED){this.player.speed-=this.world.DECREASE_SPEED*(this.grown/this.world.FOOD_INCREASE_SIZE_RATIO);this.player.originalSpeed-=this.world.DECREASE_SPEED*(this.grown/this.world.FOOD_INCREASE_SIZE_RATIO)}this.player.grow((this.player.width-this.player.originalWidth)*1.2)};this.deactivate=function(){this.player.minimize(this.grown);this.player.speed+=this.world.DECREASE_SPEED*(this.grown/this.world.FOOD_INCREASE_SIZE_RATIO);this.player.originalSpeed+=this.world.DECREASE_SPEED*(this.grown/this.world.FOOD_INCREASE_SIZE_RATIO);if(typeof this.world!="undefined"&&this.world.runes.indexOf(this)!=-1)this.world.runes.splice(this.world.runes.indexOf(this),1)};this.toJSON=function(){return{x:this.x,y:this.y,type:this.type,isActivated:this.isActivated}};this.fromJSON=function(json){this.x=json.x;this.y=json.y;this.type=json.type;this.isActivated=json.isActivated;return this}};exports.DecreaseRune=function(x,y){this.x=x;this.y=y;this.counter=0;this.player=undefined;this.type="decrease";this.width=50;this.height=50;this.isActivated=false;this.grown=0;this.image=undefined;this.world=undefined;this.color="#0015FF";this.render=function(ctx){if(this.isActivated==false&&typeof this.image!=undefined)ctx.drawImage(this.image,this.x-this.width/2,this.y-this.height/2);else if(this.isActivated==true){ctx.globalAlpha=.5;ctx.beginPath();ctx.arc(this.x,this.y,this.width,0,2*Math.PI,false);ctx.fillStyle=this.color;ctx.fill();ctx.closePath();ctx.globalAlpha=1}return this};this.update=function(){if(typeof this.player!="undefined"){this.counter++;this.x=this.player.x;this.y=this.player.y;this.width=this.player.width;if(this.counter>=TIME_ACTIVE){this.deactivate()}}};this.activate=function(player,world){this.world=world;this.player=player;this.grown=(this.player.width-this.player.originalWidth)*1.2;this.player.speed+=this.world.DECREASE_SPEED*(this.grown/this.world.FOOD_INCREASE_SIZE_RATIO);this.player.originalSpeed+=this.world.DECREASE_SPEED*(this.grown/this.world.FOOD_INCREASE_SIZE_RATIO);this.player.minimize((this.player.width-this.player.originalWidth)*1.2)};this.deactivate=function(){this.player.grow(this.grown);if(this.player.speed-this.world.DECREASE_SPEED*(this.grown/this.world.FOOD_INCREASE_SIZE_RATIO)>this.world.MINIMAL_SPEED){this.player.speed-=this.world.DECREASE_SPEED*(this.grown/this.world.FOOD_INCREASE_SIZE_RATIO);this.player.originalSpeed-=this.world.DECREASE_SPEED*(this.grown/this.world.FOOD_INCREASE_SIZE_RATIO)}if(typeof this.world!="undefined"&&this.world.runes.indexOf(this)!=-1)this.world.runes.splice(this.world.runes.indexOf(this),1)};this.toJSON=function(){return{x:this.x,y:this.y,type:this.type,isActivated:this.isActivated}};this.fromJSON=function(json){this.x=json.x;this.y=json.y;this.type=json.type;this.isActivated=json.isActivated;return this}};exports.InvisRune=function(x,y){this.x=x;this.y=y;this.counter=0;this.player=undefined;this.type="invis";this.width=50;this.height=50;this.isActivated=false;this.image=undefined;this.world=undefined;this.render=function(ctx){if(this.isActivated==false&&typeof this.image!=undefined)ctx.drawImage(this.image,this.x-this.width/2,this.y-this.height/2);return this};this.update=function(){if(typeof this.player!="undefined"){this.counter++;if(this.counter>=TIME_ACTIVE){this.deactivate()}}};this.activate=function(player,world){this.world=world;this.player=player;this.player.isInvisible=true};this.deactivate=function(){this.player.isInvisible=false;if(typeof this.world!="undefined"&&this.world.runes.indexOf(this)!=-1)this.world.runes.splice(this.world.runes.indexOf(this),1)};this.toJSON=function(){return{x:this.x,y:this.y,type:this.type,isActivated:this.isActivated}};this.fromJSON=function(json){this.x=json.x;this.y=json.y;this.type=json.type;this.isActivated=json.isActivated;return this}};exports.SlowRune=function(x,y){this.x=x;this.y=y;this.counter=0;this.player=undefined;this.width=50;this.height=50;this.isActivated=false;this.type="slow";this.image=undefined;this.world=undefined;this.color="#FF6A00";this.render=function(ctx){if(this.isActivated==false&&typeof this.image!=undefined)ctx.drawImage(this.image,this.x-this.width/2,this.y-this.height/2);else if(this.isActivated==true){ctx.globalAlpha=.5;ctx.beginPath();ctx.arc(this.x,this.y,this.width,0,2*Math.PI,false);ctx.fillStyle=this.color;ctx.fill();ctx.closePath();ctx.globalAlpha=1}return this};this.update=function(){if(typeof this.player!="undefined"){this.counter++;this.x=this.player.x;this.y=this.player.y;this.width=this.player.width;this.player.speed=this.player.originalSpeed/2;if(this.counter>=TIME_ACTIVE){this.deactivate()}}};this.activate=function(player,world){this.world=world;this.player=player;this.player.speed=this.player.originalSpeed/2};this.deactivate=function(){this.player.speed=this.player.originalSpeed*2;if(typeof this.world!="undefined"&&this.world.runes.indexOf(this)!=-1)this.world.runes.splice(this.world.runes.indexOf(this),1)};this.toJSON=function(){return{x:this.x,y:this.y,type:this.type,isActivated:this.isActivated}};this.fromJSON=function(json){this.x=json.x;this.y=json.y;this.type=json.type;this.isActivated=json.isActivated;return this}};exports.UnknownRune=function(x,y){this.x=x;this.y=y;this.counter=0;this.player=undefined;this.type="unknown";this.width=50;this.height=50;this.isActivated=false;this.image=undefined;this.world=undefined;this.rune=undefined;this.render=function(ctx){if(this.isActivated==false&&typeof this.image!=undefined)ctx.drawImage(this.image,this.x-this.width/2,this.y-this.height/2)};this.update=function(){};this.activate=function(player,world){this.world=world;this.player=player;var rnd=Math.random();if(rnd<1/5){this.rune=new runes.HasteRune(this.x,this.y)}else if(rnd<2/5){this.rune=new runes.VolumeRune(this.x,this.y)}else if(rnd<3/5){this.rune=new runes.DecreaseRune(this.x,this.y)}else if(rnd<4/5){this.rune=new runes.InvisRune(this.x,this.y)}else{this.rune=new runes.SlowRune(this.x,this.y)}this.rune.activate(this.player,this.world);this.rune.isActivated=true;this.world.runes.splice(this.world.runes.indexOf(this),1);this.world.runes.push(this.rune)};this.deactivate=function(){};this.toJSON=function(){return{x:this.x,y:this.y,type:this.type,isActivated:this.isActivated}};this.fromJSON=function(json){this.x=json.x;this.y=json.y;this.type=json.type;this.isActivated=json.isActivated;return this}}})(typeof exports==="undefined"?window:exports);if(typeof exports!="undefined"){var player=require("./player")}(function(exports){exports.Spiky=function(x,y){if(typeof window!=="undefined")Player.call(this,x,y);else player.Player.call(this,x,y);this.originalWidth=100;this.originalHeight=50;this.width=this.originalWidth;this.height=this.originalHeight;this.originalSpeed=9;this.speed=9};if(typeof window!=="undefined")exports.Spiky.prototype=Object.create(Player.prototype);else exports.Spiky.prototype=Object.create(player.Player.prototype)})(typeof exports==="undefined"?window:exports);if(typeof exports!="undefined"){var player=require("./player")}(function(exports){exports.Fish=function(x,y){if(typeof window!=="undefined")Player.call(this,x,y);else player.Player.call(this,x,y);this.originalWidth=100;this.originalHeight=50;this.width=this.originalWidth;this.height=this.originalHeight;this.originalSpeed=10;this.speed=10};if(typeof window!=="undefined")exports.Fish.prototype=Object.create(Player.prototype);else exports.Fish.prototype=Object.create(player.Player.prototype)})(typeof exports==="undefined"?window:exports);if(typeof exports!="undefined"){var player=require("./player")}(function(exports){exports.Shark=function(x,y){if(typeof window!=="undefined")Player.call(this,x,y);else player.Player.call(this,x,y);this.originalWidth=100;this.originalHeight=50;this.width=this.originalWidth;this.height=this.originalHeight;this.originalSpeed=11;this.speed=11};if(typeof window!=="undefined")exports.Shark.prototype=Object.create(Player.prototype);else exports.Shark.prototype=Object.create(player.Player.prototype)})(typeof exports==="undefined"?window:exports);
